#+TITLE: ob-cereal – Literate serial communication in Org-mode
#+AUTHOR: elemb (forked and fixed from Andreas Müller)
#+LANGUAGE: en

* What is this?

ob-cereal lets you talk to microcontrollers, sensors, Bus Pirate, or any serial device directly from Org-mode code blocks.

You write commands (Forth, AT commands, whatever) in =#+BEGIN_SRC cereal= blocks → Org sends them over real serial → you get the reply as =#+RESULTS:=.

Perfect for:
- Literate embedded development / firmware REPL sessions
- Documenting hardware experiments
- Talking to Forth systems (ZeptoForth, Mecrisp-Stellaris, noForth, amforth, etc.)
- Bus Pirate, Arduinos in serial bridge mode, FTDI adapters, etc.

* Status 2026

The original repo[](https://github.com/elemb/ob-uart) seems abandoned for many years.

This fork (renamed to ob-cereal) contains **critical fixes** that make it actually work in modern Emacs / Doom Emacs:
- proper handling of numeric parameters (:speed, :bytesize, etc.) — Org passes numbers as numbers, not strings
- symbol → string conversion for header args that are written without quotes
- removal of control characters from output (^F, ^M, other garbage)
- cleaner defaults (115200 baud, \n line ending)
- better process cleanup and timeout handling

If you find this useful, feel free to fork and contribute!

* Installation

** Doom Emacs (recommended – this is how it was tested)

1. In your =~/.doom.d/packages.el= (or =~/doom.d/packages.el=), add:

   #+begin_src emacs-lisp
   (package! ob-cereal
     :recipe (:host github :repo "elemb/ob-cereal" :files ("ob-cereal.el")))
   #+end_src

   (replace YOURUSERNAME with your GitHub name after you fork & push the fixed version)

2. Run in terminal:

   #+begin_src sh
   doom sync -u
   doom sync --rebuild    # optional but recommended after first install
   #+end_src

3. Restart Emacs completely (not just =doom/reload=).

4. In =~/.doom.d/config.el=, add:

   #+begin_src emacs-lisp
   (after! org
     (require 'ob-cereal)
     (org-babel-do-load-languages
      'org-babel-load-languages
      '((cereal . t)
        ;; you probably also want your Forth language
        (forth . t))))
   #+end_src

5. Run =doom sync= again, restart Emacs.

6. Verify:

   - =M-x eval-expression RET (featurep 'ob-cereal) RET= → should return =t=
   - =M-x eval-expression RET (fboundp 'org-babel-execute:cereal) RET= → =t=

** Vanilla Emacs (without Doom)

Add to your init file (~/.emacs.d/init.el or ~/.emacs):

#+begin_src emacs-lisp
(add-to-list 'load-path "/path/to/your/ob-cereal-folder")
(require 'ob-cereal)
(org-babel-do-load-languages
 'org-babel-load-languages
 '((cereal . t)))
#+end_src

* Quick start – ZeptoForth example (macOS)

Find your port first:

- macOS → usually =/dev/cu.usbmodem31401= or =/dev/cu.usbmodem*=
- Linux → =/dev/ttyUSB0=, =/dev/ttyACM0=, etc.

Basic block:

#+BEGIN_SRC cereal :port /dev/cu.usbmodem31401 :speed 115200 :bytesize 8 :parity none :stopbits 1 :flowcontrol none
armv6m words-in
#+END_SRC

You should see something like:

#+RESULTS:
: armv6m words-in
: ]code               code[               armv6m-instr        armv6m-internal …
:  ok

Common minimal header (copy-paste friendly):

#+BEGIN_SRC cereal :port /dev/cu.usbmodem31401 :speed 115200 :parity none :flowcontrol none
decimal 1 .
#+END_SRC

* Recommended header args

| Argument      | Typical value              | Meaning / Notes                                 |
|---------------|----------------------------|-------------------------------------------------|
| :port         | /dev/cu.usbmodem31401      | Required. Use quotes if name has spaces         |
| :speed        | 115200                     | Baud rate (number, not string)                  |
| :bytesize     | 8                          | Usually 8                                       |
| :parity       | none / odd / even          | Usually none                                    |
| :stopbits     | 1                          | Usually 1                                       |
| :flowcontrol  | none / hw / sw             | Usually none (must have value!)                 |
| :timeout      | 2                          | Seconds to wait for reply                       |
| :lineend      | \n                         | Sent after body (default)                       |
| :ienc         | raw / hex                  | Input encoding (rarely needed)                  |
| :oenc         | raw / hex / HEX            | Output decoding (rarely needed)                 |

Important: always give =:flowcontrol= a value (usually =none=). Leaving it blank causes parsing bugs.

* Troubleshooting / Gotchas

- **Still getting =wrong-type-argument: stringp, 115200= ?**
  - Old byte-compiled version is cached.
  - Fix: =rm -rf ~/.emacs.d/.local/straight/build-*/ob-cereal= then =doom sync= again + full Emacs restart.

- **No output or garbage (^F ^M etc.)**
  - The current version strips most control chars automatically.
  - If you still see junk → enable debug: =(setq ob-cereal-debug t)= and look at =*Messages*=.

- **Port not found**
  - macOS: =ls /dev/cu.*=
  - Linux: =ls /dev/ttyUSB* /dev/ttyACM*=
  - Use quotes if path has special characters.

- **Doom sync does nothing**
  - Make sure the repo URL in packages.el is correct and public (or you have auth set up).

* Bus Pirate example (still useful)

(kept from original README – works with the fixed version)

- set mode to I²C, 50 kHz
  #+BEGIN_SRC cereal :port /dev/buspirate :speed 115200 :exports both
  m 4 2
  #+END_SRC

- enable power & pull-ups
  #+BEGIN_SRC cereal :port /dev/buspirate :speed 115200
  WP
  #+END_SRC

- etc. (see original examples for SHT21 readout)

* Why literate Forth + serial is powerful

You can now:

- Keep command sequences + explanations + results in one document
- Tangle to .fs / .forth files if needed
- Use =:noweb= to compose definitions across blocks
- Version control your entire hardware conversation

Enjoy — and happy hacking!

* License

Same as original: GPLv3+
